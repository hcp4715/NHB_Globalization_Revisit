---
title: "Re-Analysis of Ruggeri et al 2022 (Pre-submission)"
output: html_notebook
author: "Hu Chuan-Peng"
---


This is a [R Markdown](http://rmarkdown.rstudio.com) Notebook for re-analyzing the sample in paper [The globalizability of temporal discounting](https://www.nature.com/articles/s41562-022-01392-w). 

Aim: Illustrate the representativeness of samples from US, China, and Nigeria in [Ruggeri et al (2022, NHB)](https://www.nature.com/articles/s41562-022-01392-w) in terms of gender, age, educational attainment, and geographical distribution. 

# Chinese sample 

```{r load libraries}
# rm(list = ls())
if (!require("pacman")) install.packages("pacman")             # install the package manager pacman
pacman::p_load('tidyverse', 'easystats', 'patchwork', 'here', 'bruceR', "tidycensus")
pacman::p_load('geojsonsf', 'RColorBrewer', 'rgdal', 'maptools', 'mapproj', 'ggsn', 'ggspatial', 'sf')
```

## Preprocessing
We extracted data from Ruggeri et al (2022). Based on the description from the pre-registration, we selected adults data (>=18 yrs old) from Chinese census data.

Excerpt from pre-registration (https://osf.io/jfvh4): *Adult participants from 18 years of age and up (in some countries, 19 or 21 is the minimum age to participate in research) will be recruited from 65 countries, covering 41 languages.*

Here is the description of the participant in the paper:

*The final dataset was composed of 13,629 responses from 61 countries. The original sample size was 25,877, which was reduced almost by half after we performed pre-registered data exclusions. We removed 6,141 participants (23.7%) who did not pass our attention check (a choice between receiving 10% of monthly income now or paying the same amount in one year). We removed 69 participants for presenting nonsensical responses to open data text (for example, ‘helicopter’ as gender). We removed 13 participants claiming to be over 100 years old. We included additional filters to our original exclusion criteria. Regarding the length of time for responses, individuals faster than three times the absolute deviation below the median time or that took less than 120 seconds to respond were removed. This criterion allowed us to identify 5,870 inappropriate responses. We further removed responses from IP addresses identified as either ‘tests’ or ‘spam’ by the Qualtrics service (264 answers identified). Lastly, we did not consider individuals not completing over 90% of the survey (9,434 responses failed this criterion). Note that these values add up to more than 100% because participants could fail multiple criteria.*

```{r data preparation}

### code for preparing census data about education, will not used after saving RData
# df_tmp <- bruceR::import(here::here("A0401_CNH_Census7_Age_education_edited.xls"))  # import data that downloaded from census website
# # 
# # # create a list of columns
# edu_colnames <- tidyr::crossing(c("pop", "noSchool", "preSchool", "elementary",
#                                   "middle", "high", "technical", "university", "master", "PhD"),
#                                 c("all", "male", "fmale")) %>%
#   dplyr::rename("edu" = 1, "sex" = 2 ) %>%
#   dplyr::mutate(edu = factor(edu, levels = c("pop", "noSchool", "preSchool", "elementary",
#                                   "middle", "high", "technical", "university", "master", "PhD"))) %>%
#   dplyr::arrange(edu) %>%
#   tidyr::unite(cols, edu:sex, remove = FALSE) %>%
#   dplyr::pull(cols)
# 
# colnames(df_tmp) <- c("Age", edu_colnames)
# 
# df_census7_edu <- df_tmp %>%
#   dplyr::mutate(Age = ifelse(Age == "85岁及以上", 85, Age)) %>%
#   dplyr::mutate(Age = as.numeric(Age)) %>%
#   dplyr::filter(!is.na(Age))

# df_census7_edu <- df_census7_edu %>% rename_with( ~ gsub("_fmale", "_female", .x, fixed = TRUE))  # replace "fmale" with "female"

# save(df_census7_age, df_census7_edu, file = here::here("CHN_Census.RData"))

# 
# Reg_Name_EN <- c("Whole_Country_Mainland", "Beijing", "Tianjin", "Hebei", "Shanxi", "Inner Mongolia", "Liaoning",
#                  "Jilin", "Heilongjiang", "Shanghai", "Jiangsu", "Zhejiang", "Anhui", "Fujian", "Jiangxi", "Shandong",
#                  "Henan", "Hubei", "Hunan", "Guangdong", "Guangxi", "Hainan", "Chongqing", "Sichuan", "Guizhou", 
#                  "Yunnan", "Tibet", "Shaanxi", "Gansu", "Qinghai", "Ningxia", "Xinjiang")
# 
# df_tmp <- bruceR::import(here::here("A0105_region_age_sex_edited.xls"))  # import data that downloaded from census website
# 
# newColNames <- colnames(df_tmp)
# newColNames <- gsub("岁", "years", newColNames)
# newColNames <- gsub("及以上", "", newColNames)
# newColNames <- gsub("-", "_", newColNames)
# newColNames[c(1,2)] <- c( "Regions", "All")
# 
# newColNames2 <- NULL
# 
# for (ii in 1:length(newColNames)){
#   # if contain ".."
#   if (grepl("...", newColNames[ii], fixed=TRUE)){
#     #print(newColNames[ii])
#     # extract the number
#     tmp_num <- as.numeric(gsub("...", "", newColNames[ii]))
#     print(tmp_num)
#     
#     # ii-1 does not contain "...", male, else, female
#     if (!grepl("...", newColNames[ii-1], fixed=TRUE)){
#       # add female to the column name
#       # print()
#       tmp_name <- paste(newColNames[ii-1], "male", sep = "_")
#     } else{
#       tmp_name <- paste(newColNames[ii-2], "female", sep = "_")
#     }
#     print(tmp_name)
#     newColNames2[ii] <- tmp_name
#   }else{
#     newColNames2[ii] <- newColNames[ii]
#   }
# }
# 
# colnames(df_tmp) <- newColNames2
# 
# df_census7_geo <- df_tmp %>%
#   dplyr::filter(!is.na(Regions)) %>%
#   dplyr::mutate(Regions = stringr::str_squish(Regions),
#                 Regions_EN = Reg_Name_EN) %>%
#   dplyr::rename(Regions_CN=Regions)

# save(df_census7_edu, dat_cn, df_census7_geo, file = here::here("Re_Analysis_CHN.RData"))
# save.image(file =  here::here("Re_Analysis_CHN.RData"))
# df_cn_census <- df_cn_census_edu
# df_cn_ruggeri2022 <- dat_cn
# df_cn_census_geo <- df_census7_geo
# save(df_cn_census, df_cn_census_geo, ChinaMap, China_border_line, file = here::here("Re_Analysis_CHN.RData"))

# Load pre-processed census data and data from Ruggeri et al 2022, not that the largest age means >= that value

# load the data from Ruggeri 2022
load(here::here("1_2_data_files.RData"))

# load data for Chinese sample
load(here::here("Re_Analysis_CHN.RData"))
province <- bruceR::import("CHNMap/province3.csv")    # for geo plot
colour   <- bruceR::import("CHNMap/colour4.csv")      # for geo plot

# import data for Nigeria
df_ng_wb <- bruceR::import('Data_extracte_WorldBankData_Series_Data.csv')
load(here::here("Re_Analysis_NG.RData"))
# the two files below are also needed
# "NG_pop_2019_wiki.csv"  # for geo
# "Re_Analysis_NG.RData"  # for geo plot

# load data for US
load(here::here("Re_Analysis_USA.RData"))    # for geo plots
# "ACSST5Y2021.S0101-2023-02-08T075713.csv"
# "ACSDT5Y2021.B15001-2023-02-08T135043.csv" 
# "DECENNIALPL2020.P1-2023-02-08T080125.csv"
```

Total number of participants in China is n = `r length(unique(df_cn_ruggeri2022$ResponseId))`.

## Sex & Age (pyramids plots)

Note that here we used only "female" and "male" to quickly check the data.

```{r CHN Sex ratio, message=FALSE, warning=FALSE}
df_cn_ruggeri2022 <- dat_unique %>%
  dplyr::filter(Residence == "China") %>%
  dplyr::select(ResponseId, Gender, EducationCompleted, Residence, Age, "Ethnic", "REGION" )

df_cn_ruggeri2022_sex <- df_cn_ruggeri2022 %>%
  dplyr::filter(Gender == "Female" | Gender == "Male") %>%
  dplyr::count(Gender) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 2) * 100,
                Site = "Ruggeri_2022") %>%
  dplyr::select(Site, Gender, Proportion) %>%
  dplyr::rename(Sex = Gender)

df_cn_census_sex <- df_cn_census %>%
  dplyr::filter(Age >= 18) %>%
  dplyr::select(pop_female, pop_male) %>%
  dplyr::mutate_if(is.character, as.numeric) %>%
  colSums() %>%
  data.frame() %>%
  dplyr::rename(N=".") %>%
  dplyr::mutate(Sex = rownames(.)) %>%
  dplyr::mutate(Sex = ifelse(Sex == "pop_female", "Female", "Male")) %>%
  dplyr::mutate(Proportion = N/sum(N)) %>%
  dplyr::mutate(Site = "Census7") %>%
  dplyr::select(Site, Sex, Proportion) %>%
  dplyr::mutate(Proportion = round(as.numeric(Proportion*100), 0)) %>%
  `rownames<-` (NULL)

df_cn_sex_ratio <- rbind(df_cn_ruggeri2022_sex, df_cn_census_sex)

fig1a <- ggplot(df_cn_sex_ratio, aes(Site, Proportion,fill=Sex)) +
  geom_col(alpha = 0.5) +
  theme_classic()+
  xlab("Data sources") +
  theme(legend.position = "none",
        # legend.key.size = unit(20,"pt"),
        # legend.box.spacing = unit(4,"pt"),
        # legend.title = element_blank(),
        axis.title = element_text(size = 16, family = "serif"),
        # legend.text = element_text(size = 16, family = "serif"),
        axis.text = element_text(size =16, family = "serif"))

fig1a 
```


### Age bins

The age bins were tailored so it start with 17 years old.

```{r CN ageBins, message=FALSE, warning=FALSE}
df_cn_ruggeri2022_age <- df_cn_ruggeri2022 %>%
  dplyr::filter(!is.na(Age)) %>%
  dplyr::mutate(ageBins_pyr = cut(Age, 
                                  breaks=c(17, 22, 27, 32, 37, 42, 47,
                                           52, 57,62, 67, Inf), 
                                  labels=c("17~21", "22~26", "27~31", "32~36", "31~41", "42~46",
                                           "47~51","52~56","57~61","62~66",">=67")),
                ageBins_pyr = factor(ageBins_pyr, 
                                     levels = c("17~21", "22~26", "27~31", "32~36", "31~41", "42~46",
                                                "47~51","52~56","57~61","62~66", ">=67"))) %>%
  dplyr::mutate(Sex = as.character(Gender)) %>%
  dplyr::filter(Sex == "Female" | Sex == "Male") %>%
  dplyr::count(ageBins_pyr, Sex) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 4) * 100) %>%
  tidyr::complete(ageBins_pyr, Sex, fill=list(Proportion=0)) %>%
  dplyr::mutate(Site = "Ruggeri_etal_2022",
                Sex = ifelse(Sex == "Female", "female_R", "male_R"))

df_cn_census_age <- df_cn_census %>%
  dplyr::filter(Age >= 18) %>%
  dplyr::select(Age, pop_female, pop_male) %>%
  dplyr::mutate_if(is.character, as.numeric) %>%
  dplyr::rename(Female = pop_female, Male=pop_male) %>%
  tidyr::pivot_longer(cols = c(Male, Female),
                      names_to = "Sex",
                      values_to = "N") %>%
  dplyr::mutate(ageBins = cut(Age,
                              breaks=c(17, 22, 27, 32, 37, 42, 47,
                                           52, 57,62, 67, Inf),
                              labels=c("17~21", "22~26", "27~31", "32~36", "31~41", "42~46",
                                           "47~51","52~56","57~61","62~66",">=67")),
                ageBins = factor(ageBins, 
                                 levels = c("17~21", "22~26", "27~31", "32~36", "31~41", "42~46",
                                           "47~51","52~56","57~61","62~66",">=67"))) %>%
  dplyr::group_by(Sex, ageBins) %>%
  dplyr::summarise(N_sum = sum(N)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Proportion = round(N_sum / sum(N_sum), 4) * 100) %>%
  tidyr::complete(ageBins, Sex, fill=list(Proportion=0))

### Plotting
fig1b <- ggplot(data= df_cn_census_age, aes(x=ageBins, y=ifelse(Sex=="Male", -Proportion, Proportion), fill=Sex)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = df_cn_ruggeri2022_age, aes(x=ageBins_pyr,
                                      y = ifelse(Sex == "male_R", -Proportion, Proportion),
                                      group=Sex,color="Ruggeri2022"), size=1, inherit.aes = FALSE) +
  # scale_y_continuous(limits = c(-15,15), sec.axis = sec_axis(~.*1, name = "Proportion (Ruggeri2022)")) +
  coord_flip() +
  labs(y="Proportion", x = "Age bins", color=NULL)+
  annotate("text",label= "italic(Male)", x=10,y=-3, parse=TRUE,size=8, family = "serif") +
  annotate("text",label= "italic(Female)", x=10,y=4, parse=TRUE,size=8,family = "serif") +
  scale_color_manual(values = c("red","blue"))+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))
fig1b
```

## Education

The coding of education in Census data and in Ruggeri et al. (2022) is different:

In the census data, there are 9 levels for educational attainment: "no school", "pre school", "primary school", "middle school", "high school", "Technical college", `Bachelor`, `Master`, and `PhD`.

In Ruggeri et al. (2022), there are seven levels and `graduate` and `MBA` were treated as different degree: `Primary ed.`, `Secondary ed.`,  `Technical ed.`, `Bachelor`, `MBA`, `Graduate`, and  `PhD`.

To make it comparable, we re-code both and used the following schema:
"noschool", "primary", "secondary" (include both middle and high school), "Technical college", "Bachelor", "master" (include graduate and MBA), and "PhD".

```{r CN_Edu}
df_cn_census_edu <- df_cn_census %>%
  dplyr::filter(Age >= 18) %>%
  dplyr::select(-ends_with("_all")) %>%
  dplyr::select(-starts_with("pop_")) %>%
  dplyr::mutate_if(is.character, as.numeric) %>%
  tidyr::pivot_longer(cols = noSchool_female: PhD_male,
                      names_to = "Edu_Sex",
                      values_to = "N") %>%
  tidyr::separate(Edu_Sex, c("Edu", "Sex")) %>%
  dplyr::group_by(Edu, Sex) %>%
  summarise(N_pop = sum(N)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Edu = dplyr::case_when(Edu == "preSchool" | Edu == "noSchool" ~ "NoSchool",
                                       Edu == "elementary" ~ "Primary",
                                       Edu == "middle" | Edu == "high" ~ "Secondary",
                                       Edu == "technical" ~ "Technical",
                                       Edu == "university" ~ "Bachelor",
                                       Edu == "master" | Edu == "PhD" ~ "Graduate",
                                       TRUE ~ "Other"
                                       ),
                Edu = factor(Edu, levels = c("NoSchool", "Primary", "Secondary", "Technical",
                                             "Bachelor", "Graduate")),
                Sex = ifelse(Sex == "female", "Female", "Male"),
                Sex = factor(Sex, levels = c("Female", "Male"))) %>%
  dplyr::group_by(Sex, Edu) %>%
  dplyr::summarise(N = sum(N_pop)) %>%
  dplyr::ungroup()  %>%
  tidyr::complete(Sex, Edu, fill = list(N=0)) %>%
  dplyr::mutate(Proportion = round(N / sum(N), 4) * 100) 
  
## Prepare data from Ruggeri et al (2022)
df_cn_ruggeri2022_edu <- df_cn_ruggeri2022 %>%
  dplyr::rename(Edu = EducationCompleted,
                Sex = Gender) %>%
  dplyr::filter(Sex == "Male" | Sex == "Female") %>%
  dplyr::mutate(Edu = dplyr::case_when(Edu == "preSchool" | Edu == "noSchool" ~ "NoSchool",
                                       Edu == "Primary ed." ~ "Primary",
                                       Edu == "Secondary ed." ~ "Secondary",
                                       Edu == "Technical ed." ~ "Technical",
                                       Edu == "Bachelor" ~ "Bachelor",
                                       Edu == "Graduate" | Edu == "MBA" | Edu == "PhD" ~ "Graduate",
                                           TRUE ~ "Other"
                                       ),
                Edu = factor(Edu, levels = c("NoSchool", "Primary", "Secondary", "Technical",
                                             "Bachelor", "Graduate")),
                Sex = factor(Sex, levels = c("Female", "Male"))) %>%
  dplyr::group_by(Sex, Edu) %>%
  dplyr::summarise(N = n()) %>%
  dplyr::ungroup() %>%
  tidyr::complete(Sex, Edu, fill = list(N=0)) %>%
  dplyr::mutate(Proportion = round(N / sum(N), 4) * 100)

fig1c <- ggplot(data= df_cn_census_edu, 
                aes(x=Edu, y=ifelse(Sex=="Male", -Proportion, Proportion), fill=Sex)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = df_cn_ruggeri2022_edu, 
            aes(x=Edu,
                y = ifelse(Sex == "Male", -Proportion, Proportion),
                group=Sex, color="Ruggeri2022"), size=1, inherit.aes = FALSE) +
  # scale_y_continuous(limits = c(-15,15), sec.axis = sec_axis(~.*1, name = "Proportion (Ruggeri2022)")) +
  coord_flip() +
  labs(y="Proportion", x = "Education attainments", color=NULL) + 
  annotate("text",label= "italic(Male)", x=6,y=-11, parse=TRUE,size=8, family = "serif") +
  annotate("text",label= "italic(Female)", x=6,y=11, parse=TRUE,size=8,family = "serif") +
  scale_color_manual(values = c("red","blue")) +
  theme_classic() +
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

fig1c
```


## Geographical distribution

After examining the proportion of data from each province, we have the following seven levels:

* > 25%
* 20% ~ 24.9%
* 15% ~ 19.9%
* 10% ~ 14.9%
* 5% ~ 9.9%
* 1% ~ 4.9%
* < 1%

We used these levels to color the map.

```{r CN geo dist}
df_cn_census_geo_adults <- df_cn_census_geo %>%
  dplyr::select(Regions_CN, 17:ncol(.)) %>%
  dplyr::select(Regions_CN, Regions_EN, everything()) %>%
  dplyr::mutate_at(c(3:56), as.numeric) %>%
  dplyr::filter(Regions_EN != "Whole_Country_Mainland") 

df_cn_census_geo_adults_all <- df_cn_census_geo_adults %>%
  dplyr::select(-contains("male")) %>%
  dplyr::mutate(N = rowSums(across(where(is.numeric)))) %>%
  dplyr::select(Regions_CN, Regions_EN,N) %>%
  dplyr::mutate(Proportion = round(N / sum(N), 3) * 100) %>%
  dplyr::mutate(PropBins = cut(Proportion,
                              breaks=c(0, 1, 5, 10, 15, 20, 25, 30), 
                              labels=c("< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                       "20~24.9%",">25%")),
                PropBins = factor(PropBins, 
                                  levels = c("< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                             "20~24.9%",">25%")),
                Colors = cut(Proportion,
                             breaks=c(0, 1, 5, 10, 15, 20, 25, 30), 
                             labels=c("1", "2", "3", "4", "5","6","7")),
                Colors = factor(Colors,
                                levels = c("0","1", "2", "3", "4", "5","6","7"))
                ) %>%
  dplyr::arrange(desc(Regions_CN))

df_cn_census_geo_adults_female <- df_cn_census_geo_adults %>%
  dplyr::select(Regions_CN, Regions_EN, contains("female")) %>%
  dplyr::mutate(N_female = rowSums(across(where(is.numeric)))) %>%
  dplyr::select(Regions_CN, Regions_EN, N_female) 

df_cn_census_geo_adults_male <- df_cn_census_geo_adults %>%
  dplyr::select(Regions_CN, Regions_EN, contains("_male")) %>%
  dplyr::mutate(N_male = rowSums(across(where(is.numeric)))) %>%
  dplyr::select(Regions_CN, Regions_EN, N_male) 

df_cn_census_geo_adults_sex <- df_cn_census_geo_adults_female %>%
  dplyr::left_join(., df_cn_census_geo_adults_male) %>%
  tidyr::pivot_longer(c(N_female, N_male), names_to = "Sex", values_to = "N") %>%
  dplyr::mutate(Sex = gsub("N_", "", Sex),
                Sex = ifelse(Sex == "female", "Female", "Male"),
                Proportion = round(N / sum(N), 3) * 100)  %>%
  dplyr::mutate(Regions_EN = factor(Regions_EN,
                                    levels = df_cn_census_geo_adults_all$Regions_EN))

df_cn_ruggeri2022_geo_sex <- df_cn_ruggeri2022 %>%
  dplyr::rename(Regions_EN = REGION, Sex=Gender) %>%
  dplyr::filter(Sex == "Female" | Sex=="Male") %>%
  dplyr::group_by(Regions_EN, Sex) %>%
  dplyr::summarise(N = n()) %>%
  dplyr::ungroup() %>%
  dplyr::filter(!is.na(Regions_EN)) %>%
  dplyr::filter(Regions_EN != "Other") %>%
  dplyr::arrange(N) %>%
  dplyr::mutate(Proportion = round(N / sum(N), 3) * 100,
                Regions_EN = factor(Regions_EN,
                                    levels = df_cn_census_geo_adults_all$Regions_EN)) 

# similar plot as for age and educational attainment, but this fig does not suit other countries, not presented in the end.
ggplot(data= df_cn_census_geo_adults_sex, 
                aes(x=Regions_EN, y=ifelse(Sex=="Male", -Proportion, Proportion), fill=Sex)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = df_cn_ruggeri2022_geo_sex, 
            aes(x=Regions_EN,
                y = ifelse(Sex == "Male", -Proportion, Proportion),
                group=Sex, color="Ruggeri2022"), size=1, inherit.aes = FALSE) +
  # scale_y_continuous(limits = c(-15,15), sec.axis = sec_axis(~.*1, name = "Proportion (Ruggeri2022)")) +
  coord_flip() +
  labs(y="Proportion", x = "Provinces (China Mainland)", color=NULL) + 
  annotate("text",label= "italic(Male)", x=30,y=-3, parse=TRUE,size=8, family = "serif") +
  annotate("text",label= "italic(Female)", x=30,y=3, parse=TRUE,size=8,family = "serif") +
  scale_color_manual(values = c("red","blue")) +
  theme_classic() +
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

### preparing the map

# count the number of participants in each province
df_cn_ruggeri2022_geo <- df_cn_ruggeri2022 %>%
  dplyr::group_by(REGION) %>%
  dplyr::summarise(N = n()) %>%
  dplyr::ungroup() %>%
  dplyr::filter(!is.na(REGION)) %>%
  dplyr::arrange(N) %>%
  dplyr::mutate(Proportion = round(N / sum(N), 3) * 100) %>%
  dplyr::mutate(PropBins = cut(Proportion,
                              breaks=c(0, 1, 5, 10, 15, 20, 25, 30), 
                              labels=c("< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                       "20~24.9%",">25%")),
                PropBins = factor(PropBins, 
                                 levels = c("< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                            "20~24.9%",">25%")),
                ) 
  
### the code was largely learnt from: https://github.com/liangliangzhuang/R_example
# API_pre <- "http://xzqh.mca.gov.cn/data/" # get map data from website
# ChinaMap <- sf::st_read(dsn = paste0(API_pre, "quanguo.json"), stringsAsFactors=FALSE) 
sf::st_crs(ChinaMap) <- 4326 # use coordinates 4326

# China_border_line <- sf::st_read(dsn = paste0(API_pre, "quanguo_Line.geojson"), stringsAsFactors=FALSE) # read border line of the country
sf::st_crs(China_border_line) = 4326
border_line_CN <- China_border_line[China_border_line$QUHUADAIMA == "guojiexian",]  ## select the map with borderline between province

# province <-  province %>%                             # get the province geo info
#   dplyr::rename(Regions_EN = 省市,                     # change colname to English in case of encoding error
#                 capitalCity = 省会)

colour <- colour %>%                                   # get the file for colour
  dplyr::mutate(QUHUADAIMA = as.character(QUHUADAIMA), 
                colour_psySample = 0,                  # add a new column for psychol sample
                colour_census = 0)                     # add a new column for census

## assign value for colour based on psychol sample
colour$colour_psySample[colour$province %in% df_cn_ruggeri2022_geo$REGION[df_cn_ruggeri2022_geo$PropBins == "< 0.9%"]] <- 1
colour$colour_psySample[colour$province %in% df_cn_ruggeri2022_geo$REGION[df_cn_ruggeri2022_geo$PropBins == "1~4.9%"]] <- 2
colour$colour_psySample[colour$province %in% df_cn_ruggeri2022_geo$REGION[df_cn_ruggeri2022_geo$PropBins == "5~9.9%"]] <- 3
colour$colour_psySample[colour$province %in% df_cn_ruggeri2022_geo$REGION[df_cn_ruggeri2022_geo$PropBins == "10~14.9%"]] <- 4
colour$colour_psySample[colour$province %in% df_cn_ruggeri2022_geo$REGION[df_cn_ruggeri2022_geo$PropBins == "15~19.9%"]] <- 5
colour$colour_psySample[colour$province %in% df_cn_ruggeri2022_geo$REGION[df_cn_ruggeri2022_geo$PropBins == "20~24.9%"]] <- 6
colour$colour_psySample[colour$province %in% df_cn_ruggeri2022_geo$REGION[df_cn_ruggeri2022_geo$PropBins == ">25%"]] <- 7

## assign value for colour based on census 7
colour$colour_census[colour$province %in% df_cn_census_geo_adults_all$Regions_EN[df_cn_census_geo_adults_all$PropBins == "< 0.9%"]] <- 1
colour$colour_census[colour$province %in% df_cn_census_geo_adults_all$Regions_EN[df_cn_census_geo_adults_all$PropBins == "1~4.9%"]] <- 2
colour$colour_census[colour$province %in% df_cn_census_geo_adults_all$Regions_EN[df_cn_census_geo_adults_all$PropBins =="5~9.9%"]] <- 3
colour$colour_census[colour$province %in% df_cn_census_geo_adults_all$Regions_EN[df_cn_census_geo_adults_all$PropBins =="10~14.9%"]] <- 4
colour$colour_census[colour$province %in% df_cn_census_geo_adults_all$Regions_EN[df_cn_census_geo_adults_all$PropBins =="15~19.9%"]] <- 5
colour$colour_census[colour$province %in% df_cn_census_geo_adults_all$Regions_EN[df_cn_census_geo_adults_all$PropBins == "20~24.9%"]] <- 6
colour$colour_census[colour$province %in% df_cn_census_geo_adults_all$Regions_EN[df_cn_census_geo_adults_all$PropBins == ">25%"]] <- 7

colour <- colour %>%
  dplyr::mutate(colour_psySample = factor(colour_psySample, 
                                    levels = c("0","1", "2", "3", "4", "5", "6","7")),
                colour_census = factor(colour_census, 
                                    levels = c("0","1", "2", "3", "4", "5", "6","7")))

ChinaMap2 <- dplyr::left_join(ChinaMap, colour,by= "QUHUADAIMA")
# head(colour)

# plot the main part
fig1d_1 <- ggplot2::ggplot() +
  ggplot2::geom_sf(data = ChinaMap2,
                   aes(fill = colour_psySample),
                   show.legend = TRUE) +
  scale_fill_manual("class",
                    values = c("#FFFFFF", "#C6DBEF","#9ECAE1","#6BAED6",
                               "#4292C6", "#2171B5", "#08519C","#08306B"),
                    breaks = c("0","1",   "2", "3", 
                               "4", "5", "6","7"),
                    labels = c("0",       "<0.9%",    "1~4.9%", "5~9.9%", 
                               "10~14.9%", "15~19.9%", "20~24.9%",">25%")
                    ) +
  ggplot2::geom_sf(data = border_line_CN) +
  # geom_text(data = province,
  #           aes(x = dili_Jd, y = dili_Wd, label = Regions_EN),
  #       position = "identity",
  #       size = 3,
  #       check_overlap = TRUE
  #     ) +
      labs(title = "Geographical distribution (Ruggeri_2022)") +
      theme(
        plot.title = element_text(
          color = "black",
          size = 16,
          face = "bold",
          vjust = 0.1,
          hjust = 0.5
        ),
        legend.title = element_blank(),
        # legend.position = "bottom", 
        # legend.justification = "left",
        # legend.direction = "horizontal",
        legend.position =  c(0.9, 0.58), # position of legend
        legend.text=element_text(size=rel(1.5)),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()
      ) +
  ## add north arrow, the style can be changed
      annotation_north_arrow(
        location = 'tl',
        which_north = 'false',
        style = north_arrow_fancy_orienteering()
      )

fig1e_1 <-  ggplot() +
  geom_sf(
    data = ChinaMap2,
    aes(fill = colour_census)) +
    ## 填色
  scale_fill_manual(
        # "class",
        values = c("#FFFFFF", "#C6DBEF","#9ECAE1","#6BAED6",
                    "#4292C6", "#2171B5", "#08519C","#08306B"),
        breaks = c("0","1",   "2", "3", 
                   "4", "5", "6","7"),
        labels = c("0",       "< 0.9%",    "1~4.9%", "5~9.9%", 
                   "10~14.9%", "15~19.9%", "20~24.9%",">25%"),
        drop = FALSE  ## force to show all levels
      ) +
      geom_sf(data = border_line_CN) +
      geom_text(
        data = province,
        aes(x = dili_Jd, y = dili_Wd, label = Regions_EN), ##添加省份名称
        position = "identity",
        size = 3,
        check_overlap = TRUE
      ) +
      guides(fill="none") + 
      labs(title = "Geographical distribution (Census data)") +
      theme(
        plot.title = element_text(
          color = "black",
          size = 16,
          face = "bold",
          vjust = 0.1,
          hjust = 0.5
        ),
        # legend.title = element_blank(),
        legend.position =  c(0.95, 0.58), # position of legend
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()
      ) +
      annotation_north_arrow(
        location = 'tl',
        which_north = 'false',
        style = north_arrow_fancy_orienteering()
      )

fig1 <- (fig1a + fig1b + fig1c + plot_layout(guides = "collect") ) /
  (fig1e_1 + fig1d_1 + plot_layout(guides = "collect")) + 
  plot_annotation(tag_levels = 'A', title = "Data of China",
                  theme = theme(plot.title = element_text(size = 26))) + 
  plot_layout(heights = c(1, 1.5)) &
  theme(plot.tag = element_text(size = 24),
        text = element_text("Times"))

ggsave("fig1_CN.pdf", fig1, device = "pdf", width=18, height = 15)
fig1
```

# Nigeria Data

The data of Nigeria are from different sources. 

For age and sex data, we extracted data from World bank, which has 2021 data.

The geographical data are from [wikipeida](https://en.wikipedia.org/wiki/Demographics_of_Nigeria).

The educational attainment data are from [DHS](https://dhsprogram.com/methodology/survey/survey-display-528.cfm)

## Sex ratio
```{r Nigeria Sex ratio}

# Nigeria's data from Ruggeri
df_ng_ruggeri <- dat_unique %>%
  dplyr::filter(Residence == "Nigeria") %>%
  dplyr::select(ResponseId, Gender, EducationCompleted, Residence, Age, "Ethnic", "REGION" ) %>%
  dplyr::filter(Gender == "Female" | Gender == "Male")
# str(df_ng_wb)
# We will use the 2021 data 
df_ng_census2021 <- df_ng_wb %>%
  dplyr::filter(`Country Name` == "Nigeria") %>%
  dplyr::select(1,3, 4, 9) %>%
  dplyr::rename("YR2021" = `2021 [YR2021]`) %>%
  dplyr::mutate(YR2021_num = as.numeric(YR2021)) %>%
  dplyr::filter(!is.na(YR2021_num)) 

df_ng_census2021_pop <-  df_ng_census2021 %>%
  dplyr::filter(!str_detect(`Series Name`,"%|\\(|-|\\d")) %>%
  dplyr::mutate(Cat = str_replace(`Series Name`, "Population, | population|,|Population in ", "")) %>%
  dplyr::mutate(Cat = str_replace(Cat, "largest city", "largest_city")) %>%
  dplyr::select(YR2021_num, Cat) %>%
  tidyr::pivot_wider(names_from = Cat, values_from = YR2021_num) 

### Sex ratio
df_ng_census2021_sex <- df_ng_census2021_pop %>%
  dplyr::select(female, male) %>%
  tidyr::pivot_longer(female:male, names_to = "Sex", values_to = "N") %>%
  dplyr::mutate(Proportion = round(N / sum(N), 4) * 100,
                Source = "Census_2021",
                Sex = ifelse(Sex == "female", "Female", "Male"),
                Sex = factor(Sex, levels = c("Female", "Male"))) %>%
  dplyr::select(Source, Sex, Proportion)
  
df_ng_ruggeri_sex <- df_ng_ruggeri %>%
  dplyr::filter(Gender == "Female" | Gender == "Male") %>%
  dplyr::count(Gender) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 4) * 100,
                Source = "Ruggeri_2022")  %>%
  dplyr::rename(Sex = Gender) %>%
  dplyr::select(Source, Sex, Proportion) %>%
  dplyr::mutate(Sex = ifelse(Sex == "Female", "Female", "Male"),
                Sex = factor(Sex, levels = c("Female", "Male")))

df_ng_sex_ratio <- rbind(df_ng_census2021_sex, df_ng_ruggeri_sex)

fig2a <- ggplot(df_ng_sex_ratio, aes(Source, Proportion,fill=Sex)) +
  geom_col(alpha = 0.5) +
  theme_classic()+
  xlab("Data sources") +
  theme(legend.position = "none",
        # legend.key.size = unit(20,"pt"),
        # legend.box.spacing = unit(4,"pt"),
        # legend.title = element_blank(),
        axis.title = element_text(size = 16, family = "serif"),
        # legend.text = element_text(size = 16, family = "serif"),
        axis.text = element_text(size =16, family = "serif"))

fig2a 
```
## Age bins
```{r Nigeria age bins}
Age_bins_ng_all <- c("00-04", "05-09", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", 
                 "50-54", "55-59", "60-64", "65-69", "70-74", "75-79","80-120")

Age_bins_ng_val <- c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", 
                 "50-54", "55-59", "60-64", "65-69", "70-74", "75-79","80-120")

Age_bins_ng_final <- c("15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", 
                       "50-54", "55-59", "60-64", ">=65")

df_ng_census2021_age <- df_ng_census2021 %>%
  dplyr::filter(str_detect(`Series Name`,"%")) %>%
  dplyr::filter(str_detect(`Series Name`,"ages")) %>%
  dplyr::mutate(Agebins = str_replace(`Series Name`, "Population ages ", "")) %>%
  dplyr::mutate(Agebins = str_replace(Agebins, " and above", "-120")) %>%
  dplyr::filter(str_detect(Agebins, "male")) %>%
  tidyr::separate(., col = Agebins, into = c("age", "sex", "note"), sep = ",|\\(") %>%
  dplyr::mutate(sex = str_replace_all(sex, "\\s", "")) %>% # remove all white space
  dplyr::mutate(note = str_replace(note, "\\)", "")) %>%
  dplyr::mutate(Percent = YR2021_num/100) %>%
  dplyr::mutate(sex = str_replace_all(sex, "\\s", "")) %>%
  dplyr::mutate(Pop = ifelse(sex == "female", 
                             round(Percent * df_ng_census2021_pop$female, 0),
                             round(Percent * df_ng_census2021_pop$male,0)),
                Pop_percent = Pop/df_ng_census2021_pop$total) %>%
  dplyr::filter(age %in% Age_bins_ng_val) %>%
  dplyr::select(2,3,6,7, 11, 10, 1) %>%
  dplyr::mutate(ageBins = age) %>%
  dplyr::arrange(ageBins, sex) %>%
  dplyr::rename(Sex = sex,
                Proportion = Pop_percent) %>%
  dplyr::mutate(Proportion = Proportion * 100,
                Sex = ifelse(Sex == "male", "Male", "Female")) %>%
  dplyr::select(ageBins, Sex, Proportion)%>%
  dplyr::mutate(ageBins = ifelse(ageBins %in% Age_bins_ng_val[1:10], ageBins, # sum all above 65
                                 ">=65"),
                ageBins = factor(ageBins, levels = Age_bins_ng_final)) %>%
  dplyr::group_by(ageBins, Sex) %>%
  dplyr::summarise(Proportion = sum(Proportion)) %>%
  dplyr::ungroup()

df_ng_ruggeri_age <- df_ng_ruggeri %>%
  dplyr::filter(!is.na(Age)) %>%
    dplyr::mutate(ageBins = cut(Age, 
                                breaks=c(15, 20, 25, 30, 35, 40, 45,
                                         50, 55, 60, 65, Inf), 
                                labels=Age_bins_ng_final),
                ageBins = factor(ageBins, 
                                 levels =Age_bins_ng_final)) %>%
  dplyr::mutate(Sex = as.character(Gender)) %>%
  dplyr::count(ageBins, Sex) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 4) * 100) %>%
  tidyr::complete(ageBins, Sex, fill=list(Proportion=0)) %>%
  dplyr::mutate(Site = "Ruggeri_etal_2022")
  
fig2b <- ggplot(data = df_ng_census2021_age, 
       aes(x=ageBins, y=ifelse(Sex=="Male", -Proportion, Proportion), fill=Sex)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = df_ng_ruggeri_age, aes(x=ageBins,
                                      y = ifelse(Sex == "Male", -Proportion, Proportion),
                                      group=Sex,color="Ruggeri2022"), size=1, inherit.aes = FALSE) +
  scale_y_continuous(limits = c(-21, 21)) +
  coord_flip() +
  labs(y="Proportion", x = "Age bins", color=NULL)+
  annotate("text",label= "italic(Male)", x=10,y=-10, parse=TRUE,size=8, family = "serif") +
  annotate("text",label= "italic(Female)", x=10,y=11, parse=TRUE,size=8,family = "serif") +
  scale_color_manual(values = c("red","blue"))+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

fig2b
```

## Educational attainments
```{r Nigeria edu}

### tried to use data from world bank, but did not find useful information
# ng_vars <- wb_search("^(?=.*education)(?=.*population)(?!.*25+).*", perl = TRUE)
# 
# indcators <- ng_vars %>%
#   dplyr::filter(!str_detect(indicator_id, "HH.DHS.GAR.456|HH.DHS.NIR|HH.MICS.GAR|PRJ.ATT.2039.3|SE.PRE.NENR")) %>%
#   dplyr::filter(!str_detect(indicator_id,"SI.POV|UIS.AIR|UIS.GGR|UIS.NAR|UIS.NER|UIS.NIR|UIS.SLEN|UIS.XGOVEXP"))
# 
# ng_vars_df <- wb_data(country = "NGA",
#                       indicator = indcators$indicator_id,
#                       # start_date = 2019, end_date = 2023,
#                       mrv = 1, 
#                       return_wide = FALSE
#                       ) 
# 
# ng_vars_df_2 <- ng_vars_df %>%
#   dplyr::select(where(~!all(is.na(.x)))) %>%
#   dplyr::filter(!str_detect(indicator, "Labor force"))
# 
# ng_vars_Wittgenstein <- ng_vars_df_2 %>%
#   dplyr::filter(str_detect(indicator, "Wittgenstein")) %>%
#   dplyr::filter(!str_detect(indicator, "\\+|\\-|thousands")) %>%
#   dplyr::select(where(~!all(is.na(.x)))) %>%
#   dplyr::filter(str_detect(indicator, "Total")) 
# 
# ng_vars_UIS <- ng_vars_df_2 %>%
#   dplyr::filter(str_detect(indicator_id, "UIS")) %>%
#   dplyr::filter(!str_detect(indicator, "\\+|\\-|thousands")) %>%
#   dplyr::select(where(~!all(is.na(.x)))) %>%
#   dplyr::filter(str_detect(indicator, "Total")) 

### using the data from DHS, page 44
#  Women and men age 15-49
## Nigeria's education,  6-3-3-4 system
# primary: 5/6 ~ 11/12
# Junior secondary: 11/12 ~ 14/15
# Senior Secondary: 14/15 ~ 17/18
# Tertiary institution (Uni, Polytech, MonoTech, College)
# ng_edu_prop <- data.frame(female = c(35, 4, 10, 16, 23, 11),
#                             male = c(22, 3, 11, 16, 32, 17),
#                           educ = c("No_Edu", "Some_Primary", "Complted primary", "Some_secondary", 
#                                    "Completed_secondary", "More_than_secondary"))

df_ng_DHS2018_edu <- data.frame(Female = c(35, 14, 16, 23, 12), # originally sum up to 99, randomly added on to 100%
                                Male = c(22, 14, 16, 32, 16),   # originally sum up to 101
                                Edu = c("NoSchool", "Primary", "Some_secondary", 
                                        "Secondary", "Tertiary")) %>%
  dplyr::mutate(Female = Female/2,
                Male = Male/2) %>%
  tidyr::pivot_longer(cols = Female:Male,names_to = "Sex", values_to = "Proportion") %>%
  dplyr::mutate(Sex = factor(Sex, levels = c("Female", "Male"))) %>%
  dplyr::mutate(Edu = factor(Edu, 
                             levels = c("NoSchool", "Primary", "Some_secondary", "Secondary", "Tertiary"))) %>%
  dplyr::select(Sex, Edu, Proportion)

## Prepare data from Ruggeri et al (2022)
df_ng_ruggeri_edu <- df_ng_ruggeri %>%
  dplyr::filter(!is.na(EducationCompleted)) %>%
  dplyr::mutate(Edu = dplyr::case_when(EducationCompleted == "Bachelor" ~ "Tertiary",
                                       EducationCompleted == "Secondary ed." ~ "Secondary",
                                       EducationCompleted == "Technical ed." ~ "Tertiary",
                                       TRUE ~ "Other"
                                ),
                Edu = factor(Edu, levels = c("NoSchool", "Primary", "Some_secondary", "Secondary", "Tertiary"))) %>%
  dplyr::mutate(Gender = factor(Gender, levels = c("Female", "Male"))) %>%
  dplyr::rename(Sex = Gender) %>%
  dplyr::group_by(Sex, Edu) %>%
  dplyr::summarise(N = n()) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Proportion = round(N / sum(N), 4) * 100) %>%
  tidyr::complete(Sex, Edu,
                  fill = list(Proportion =0))%>%
  dplyr::select(Sex, Edu, Proportion)

fig2c <- ggplot(data= df_ng_DHS2018_edu,
                aes(x=Edu, y=ifelse(Sex=="Male", -Proportion, Proportion), fill=Sex)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = df_ng_ruggeri_edu, 
            aes(x=Edu,
                y = ifelse(Sex == "Male", -Proportion, Proportion),
                group=Sex, color="Ruggeri2022"), size=1, inherit.aes = FALSE) +
  # scale_y_continuous(limits = c(-15,15), sec.axis = sec_axis(~.*1, name = "Proportion (Ruggeri2022)")) +
  coord_flip() +
  labs(y="Proportion", x = "Education attainments", color=NULL) + 
  annotate("text",label= "italic(Male)", x=5,y=-20, parse=TRUE,size=8, family = "serif") +
  annotate("text",label= "italic(Female)", x=5,y=20, parse=TRUE,size=8,family = "serif") +
  scale_color_manual(values = c("red","blue")) +
  theme_classic() +
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

fig2c
```
## Geo-distribution

```{r Nigeria Map}
# copied from https://en.wikipedia.org/wiki/List_of_Nigerian_states_by_population#cite_note-2
# ng_data <- read_clip_tbl()
# 
# ng_data <- ng_data %>%
#   dplyr::rename(Orders = 1)
# 
# ng_data <- ng_data %>%
#   dplyr::rename(Pop_2006 = 3,
#                 Pop_2019 = 4)
# 
# ng_data_new <- ng_data %>%
#   dplyr::mutate(State = str_remove(State, " State"),
#                 Orders = ifelse(Orders == "–", "37", Orders),
#                 Pop_2019 = str_remove_all(Pop_2019, ",")) %>%
#   dplyr::mutate(Pop_2019 = as.numeric(Pop_2019)) %>%
#   dplyr::filter(State != "Nigeria") %>%
#   dplyr::select(-Pop_2006) %>%
#   dplyr::mutate(Proportion = round(Pop_2019 / sum(Pop_2019), 3) * 100)
# 
# write_csv(ng_data_new, "NG_pop_2019_wiki.csv", )

# extract Nigeria's data
# df_ng_ruggeri <- dat_unique %>%
#   dplyr::filter(Residence == "Nigeria") %>%
#   dplyr::select(ResponseId, Gender, EducationCompleted, Residence, Age, "Ethnic", "REGION" )

# library(remotes)
# remotes::install_github("wmgeolab/rgeoboundaries")
# 
# df_ng_map <- rgeoboundaries::geoboundaries("Nigeria", "adm1") # need internet
# 
# save(df_ng_map, file = here::here("Re_Analysis_NG.RData")) # save as rdata

load(here::here("Re_Analysis_NG.RData"))

df_ng_census2019_geo <- bruceR::import("NG_pop_2019_wiki.csv") %>%
  dplyr::select(State, Proportion) %>%
  dplyr::rename(state = State) %>%
  dplyr::arrange(state) %>%
  dplyr::mutate(PropBins = cut(Proportion,
                              breaks=c(0, 1, 5, 10, 15, 20, 25, 30), 
                              labels=c("< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                       "20~24.9%",">25%")),
                  PropBins = factor(PropBins, 
                                    levels = c("0","< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                               "20~24.9%",">25%")),
                  Colors = cut(Proportion,
                               breaks=c(0, 1, 5, 10, 15, 20, 25, 30), 
                               labels=c("1", "2", "3", "4", "5","6","7")),
                  Colors = factor(Colors, 
                                  levels = c("0","1", "2", "3", "4", "5","6","7")),
                  ) 

fig2d <- ggplot2::ggplot(data = df_ng_map, aes(fill = df_ng_census2019_geo$Colors)) +
  ggplot2::geom_sf(show.legend = TRUE) +
  scale_fill_manual("Proportions",
                    values = c("#FFFFFF", "#C6DBEF","#9ECAE1","#6BAED6",
                               "#4292C6", "#2171B5", "#08519C","#08306B"),
                    breaks = c("0","1",   "2", "3", 
                               "4", "5", "6","7"),
                    labels = c("0",       "<0.9%",    "1~4.9%", "5~9.9%", 
                               "10~14.9%", "15~19.9%", "20~24.9%",">25%"),
                    drop = FALSE,
      ) + 
  labs(title = "Geographical distribution (Census data)") +
  theme(
        plot.title = element_text(
          color = "black",
          size = 16,
          face = "bold",
          vjust = 0.1,
          hjust = 0.5
        ),
        legend.title = element_blank(),
        # legend.position = "bottom", 
        # legend.justification = "left",
        # legend.direction = "horizontal",
        legend.position =  c(0.9, 0.58), # position of legend
        legend.text=element_text(size=rel(1.5)),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()
      ) +
  ## add north arrow, the style can be changed
      ggspatial::annotation_north_arrow(
        location = 'tl',
        which_north = 'false',
        style = ggspatial::north_arrow_fancy_orienteering()
      ) 

df_ng_ruggeri_geo <- df_ng_ruggeri %>%
  dplyr::filter(!is.na(REGION)) %>%
  dplyr::rename(state = REGION) %>%
  dplyr::mutate(state = as.character(state),
                state = ifelse(state == "Andamawa", "Adamawa", state)) %>% # correct two values that are not the name of states
  dplyr::arrange(state) %>%
  dplyr::group_by(state) %>%
  dplyr::summarise(state_n = n()) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Proportion = round(state_n / sum(state_n), 3) * 100) %>%
  dplyr::mutate(state = ifelse(state %in% naijR::states(), state, naijR::states()),
                state = factor(state, levels = naijR::states() )) %>%
  dplyr::mutate(PropBins = cut(Proportion,
                              breaks=c(0, 1, 5, 10, 15, 20, 25, 100), 
                              labels=c("< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                       "20~24.9%",">25%")),
                  PropBins = factor(PropBins, 
                                    levels = c("0","< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                               "20~24.9%",">25%")),
                  Colors = cut(Proportion,
                               breaks=c(0, 1, 5, 10, 15, 20, 25, 100), 
                               labels=c("1", "2", "3", "4", "5","6","7")),
                  Colors = factor(Colors, 
                                  levels = c("0","1", "2", "3", "4", "5","6","7")),
                  ) %>%
  tidyr::complete(state, fill = list(Proportion=0, PropBins = "0", Colors="0")) %>%
  dplyr::mutate(state = as.character(state))

fig2e <- ggplot2::ggplot(data = df_ng_map, aes(fill = df_ng_ruggeri_geo$Colors)) +
  ggplot2::geom_sf(show.legend = TRUE) +
  scale_fill_manual("Proportions",
                    values = c("#FFFFFF", "#C6DBEF","#9ECAE1","#6BAED6",
                               "#4292C6", "#2171B5", "#08519C","#08306B"),
                    breaks = c("0","1",   "2", "3", 
                               "4", "5", "6","7"),
                    labels = c("0",       "<0.9%",    "1~4.9%", "5~9.9%", 
                               "10~14.9%", "15~19.9%", "20~24.9%",">25%"),
                    drop = FALSE,
      ) + 
  labs(title = "Geographical distribution (Ruggeri_2022)") +
  theme(
        plot.title = element_text(
          color = "black",
          size = 16,
          face = "bold",
          vjust = 0.1,
          hjust = 0.5
        ),
        legend.title = element_blank(),
        # legend.position = "bottom", 
        # legend.justification = "left",
        # legend.direction = "horizontal",
        legend.position =  c(0.9, 0.58), # position of legend
        legend.text=element_text(size=rel(1.5)),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()
      ) +
  ## add north arrow, the style can be changed
      ggspatial::annotation_north_arrow(
        location = 'tl',
        which_north = 'false',
        style = ggspatial::north_arrow_fancy_orienteering()
      ) 

# fig2de <- fig2d + fig2e + plot_layout(guides = "collect")
# fig2de

fig2 <- (fig2a + fig2b + fig2c + plot_layout(guides = "collect") ) /
  (fig2d + fig2e + plot_layout(guides = "collect")) + 
  plot_annotation(tag_levels = 'A', title = "Data of Nigeria",
                  theme = theme(plot.title = element_text(size = 26))) + 
  plot_layout(heights = c(1, 1.5)) &
  theme(plot.tag = element_text(size = 24),
        text = element_text("Times"))

ggsave("fig1_NG.pdf", fig2, device = "pdf", width=18, height = 15)
fig2
```

# US data

## sex ratio
```{r US data Sex}
## data downloaded from: https://data.census.gov
df_us_census_age <- bruceR::import("ACSST5Y2021.S0101-2023-02-08T075713.csv") %>%
  dplyr::select(`Label (Grouping)`, contains("Estimate")) %>%
  dplyr::rename("ageBins" = 1, "Total" = 2, "Total_prop" = 3, 
                "Male" = 4, "Male_prop" = 5, "Female" = 6, "Female_prop" = 7)%>%
  dplyr::select("ageBins", "Total", "Male", "Female") %>%
  dplyr::mutate(Total = as.integer(gsub(",", "", as.character(.$Total))),
                #Total_prop = as.numeric(gsub("%", "", as.character(.$Total_prop))),
                Male = as.integer(gsub(",", "", as.character(.$Male))),
                #Male_prop = as.numeric(gsub("%", "", as.character(.$Male_prop))),
                Female = as.integer(gsub(",", "", as.character(.$Female))),
                #Female_prop = as.numeric(gsub("%", "", as.character(.$Female_prop))),
                ) 
## sex ratio
df_us_census_sex <- df_us_census_age %>%
  dplyr::slice(1) %>%
  dplyr::mutate(Male = round(100*Male/Total, 1),
                Female = round(100*Female/Total, 1)) %>%
  dplyr::select(-Total) %>%
  tidyr::pivot_longer(cols = Male:Female,
                      names_to = "Sex",
                      values_to = "Proportion") %>%
  dplyr::rename(Site = ageBins) %>%
  dplyr::mutate(Site = "Census")

df_us_ruggeri2022 <- dat_unique %>%
  dplyr::filter(Residence == "United_States") %>%
  dplyr::select(ResponseId, Gender, EducationCompleted, Residence, Age, "Ethnic", "REGION" ) 

df_us_ruggeri_sex <- df_us_ruggeri2022 %>%
  dplyr::filter(Gender == "Female" | Gender == "Male") %>%
  dplyr::count(Gender) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 4) * 100,
                Site = "Ruggeri2022") %>%
  dplyr::select(Site, Gender, Proportion) %>%
  dplyr::rename(Sex = Gender)

df_us_sex_ratio <- rbind(df_us_census_sex, df_us_ruggeri_sex) %>%
  dplyr::mutate(Sex = factor(Sex, levels = c("Female", "Male")),
                Site = factor(Site, levels = c("Census", "Ruggeri2022")))

fig3a <- ggplot(df_us_sex_ratio, aes(Site, Proportion,fill=Sex)) +
  geom_col(alpha=0.5)+
  theme_classic()+
  #coord_flip() +
  xlab("Data sources") +
  theme(legend.position = "none",
        #legend.key.size = unit(20,"pt"),
        #legend.box.spacing = unit(4,"pt"),
        #legend.title = element_blank(),
        axis.title = element_text(size = 16, family = "serif"),
        #legend.text = element_text(size = 16, family = "serif"),
        axis.text = element_text(size =16, family = "serif"))

fig3a
```

```{r US data age bins}
## age bins
df_us_census_age_all <- df_us_census_age %>%
  dplyr::slice(3:15, 32) %>%
  dplyr::mutate(Male = round(100*Male/sum(Total), 1),
                Female = round(100*Female/sum(Total), 1)) %>%
  dplyr::slice(4:14) %>%
  dplyr::mutate(ageBins = Age_bins_ng_final,
                ageBins = factor(ageBins, levels = Age_bins_ng_final)) %>%
  dplyr::select(ageBins,Male,Female) %>%
  tidyr::pivot_longer(cols = Male:Female, 
                      names_to = 'Sex',
                      values_to = "Proportion") %>%
  dplyr::mutate(Sex = factor(Sex, levels = c("Female", "Male")))

df_us_ruggeri2022_age <- df_us_ruggeri2022 %>%
  dplyr::filter(Gender == "Female" | Gender == "Male") %>%
  dplyr::filter(!is.na(Age)) %>%
    dplyr::mutate(ageBins = cut(Age, 
                                  breaks=c(15, 20, 25, 30, 35, 40, 45,
                                           50, 55, 60, 65, Inf), 
                                  labels=Age_bins_ng_final),
                ageBins = factor(ageBins, 
                                     levels =Age_bins_ng_final)) %>%
  dplyr::mutate(Sex = as.character(Gender)) %>%
  dplyr::count(ageBins, Sex) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 4) * 100) %>%
  tidyr::complete(ageBins, Sex, fill=list(Proportion=0)) %>%
  dplyr::mutate(Site = "Ruggeri_etal_2022",
                Sex = factor(Sex, levels = c("Female", "Male")))
  
fig3b <- ggplot(data = df_us_census_age_all, aes(x=ageBins, y=ifelse(Sex=="Male", -Proportion, Proportion), fill=Sex)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = df_us_ruggeri2022_age, 
            aes(x=ageBins,
                y = ifelse(Sex == "Male", -Proportion, Proportion),
                group=Sex, color="Ruggeri2022"), size=1, inherit.aes = FALSE) +
  scale_y_continuous(limits = c(-15, 15)) +
  coord_flip() +
  labs(y="Proportion", x = "Age bins", color=NULL)+
  annotate("text",label= "italic(Male)", x=10,y=-7, parse=TRUE,size=8, family = "serif") +
  annotate("text",label= "italic(Female)", x=10,y=8, parse=TRUE,size=8,family = "serif") +
  scale_color_manual(values = c("red","blue"))+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))
fig3b
```

```{r US data education}
### education: 
# American Community Survey
# B15001SEX BY AGE BY EDUCATIONAL ATTAINMENT FOR THE POPULATION 18 YEARS AND OVER
# 2021: ACS 5-Year Estimates Detailed Tables
df_us_census_edu <- bruceR::import("ACSDT5Y2021.B15001-2023-02-08T135043.csv") %>%
  dplyr::select(`Label (Grouping)`, contains("Estimate")) %>%
  dplyr::rename(Label = 1,
                Estimate = 2) %>%
  dplyr::mutate(Estimate = as.integer(gsub(",", "", as.character(.$Estimate))),
                #Label = str_remove_all(Label, " ")
                )

df_us_census_edu_all <- df_us_census_edu %>%
  dplyr::slice(-c(1, 2, 43)) %>%
  dplyr::mutate(Sex = rep(c("Male", "Female"), each=40),
                Label = str_trim(Label, side = "both")) %>% # find this function took me > 20 minutes.
  dplyr::mutate(Edu = dplyr::case_when(Label == "Less than 9th grade" ~ "Primary",
                                       Label == "9th to 12th grade, no diploma" ~ "Primary",
                                       Label == "High school graduate (includes equivalency)" ~ "Secondary",
                                       Label == "Some college, no degree" ~ "Secondary",
                                       Label == "Bachelor's degree" ~ "Bachelor",
                                       Label == "Graduate or professional degree" ~ "Graduate",
                                       TRUE ~ "Other"
                                       ),
                ageBins = rep(rep(c("18-24", "25-34", "35-44","45-64", ">=65"), each=8), 2)) %>%
  dplyr::filter(Edu != "Other") %>%
  dplyr::group_by(Sex, Edu) %>%
  dplyr::summarise(N = sum(Estimate)) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(Edu = factor(Edu, 
                             levels = c("NoSchool", "Primary", "Secondary",
                                        "Bachelor", "Graduate")),
                Sex = factor(Sex, levels = c("Female", "Male"))) %>%
  dplyr::arrange(Sex, Edu) %>%
  tidyr::complete(Sex, Edu,
                  fill = list(N =0)) %>%
  dplyr::mutate(Proportion = round(N / sum(N), 4) * 100,
                Source = "Census_2021")

df_us_ruggeri_edu <- df_us_ruggeri2022 %>%
  dplyr::filter(Gender == "Female" | Gender == "Male") %>%
  dplyr::filter(!is.na(EducationCompleted)) %>%
  dplyr::mutate(Edu = dplyr::case_when(EducationCompleted  == "MBA" ~ "Graduate",
                                EducationCompleted  == "PhD" ~ "Graduate",
                                EducationCompleted  == "Graduate" ~ "Graduate",
                                EducationCompleted  == "Primary ed." ~ "Primary",
                                EducationCompleted  == "Secondary ed." ~ "Secondary",
                                EducationCompleted  == "Technical ed." ~ "Bachelor",
                                EducationCompleted  == "Bachelor" ~ "Bachelor",
                                )) %>%
  dplyr::group_by(Gender, Edu) %>%
  dplyr::summarise(N = n()) %>%
  dplyr::ungroup() %>%
  dplyr::rename(Sex = Gender) %>%
  dplyr::mutate(Edu = factor(Edu, levels = c("NoSchool", "Primary", "Secondary",
                                        "Bachelor", "Graduate")),
                Sex = factor(Sex, levels = c("Female", "Male"))) %>%
  tidyr::complete(Sex, Edu,
                  fill = list(N =0)) %>%
  dplyr::mutate(Proportion = round(N / sum(N), 4) * 100,
                Source = "Ruggeri_2022")

df_us_edu <- rbind(df_us_ruggeri_edu, df_us_census_edu_all)

# tried to use col plot, not used in the end
ggplot(df_us_edu, aes(x=Proportion, y=Source, fill=Edu)) +
  geom_col(alpha = .75)+
  labs(y="Sex") + 
  scale_fill_discrete(label=c("NoSchool", "Primary", "Secondary", "Bachelor", "Graduate")) +
  theme_classic() +
  # guides(y="axis_nested") +
  theme(legend.title = element_text(size = 15,family = "serif"),
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +
  facet_wrap(~ Sex, scales = "free")

fig3c <- ggplot(data= df_us_census_edu_all, aes(x=Edu, y=ifelse(Sex=="Male", -Proportion, Proportion), fill=Sex)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = df_us_ruggeri_edu, 
            aes(x=Edu,
                y = ifelse(Sex == "Male", -Proportion, Proportion),
                group=Sex, color="Ruggeri2022"), size=1, inherit.aes = FALSE) +
  # scale_y_continuous(limits = c(-15,15), sec.axis = sec_axis(~.*1, name = "Proportion (Ruggeri2022)")) +
  coord_flip() +
  labs(y="Proportion", x = "Education attainments", color=NULL) + 
  annotate("text",label= "italic(Male)", x=5,y=-15, parse=TRUE,size=8, family = "serif") +
  annotate("text",label= "italic(Female)", x=5,y=15, parse=TRUE,size=8,family = "serif") +
  scale_color_manual(values = c("red","blue")) +
  theme_classic() +
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

# fig3_abc <- fig3a + fig3b + fig3c + plot_annotation(tag_levels = 'A')#  + plot_layout(heights = c(1, 1.3))
# 
# ggsave("fig3_abc_USData.pdf", fig3_abc, device = "pdf", width=15, height = 9)

fig3c
```

```{r US data Map}
# census_api_key("", install = TRUE, overwrite=TRUE)
# readRenviron("~/.Renviron")
# 
# us_median_age <- get_acs(
#   geography = "state",
#   variables = "B01002_001",
#   year = 2019,
#   survey = "acs1",
#   geometry = TRUE,
#   resolution = "20m"
# ) %>%
#   shift_geometry()
# df_us_map <- us_median_age # data downloaded from gov
# save(df_us_map, file = here::here("Re_Analysis_USA.RData"))

df_us_census_geo <- bruceR::import("DECENNIALPL2020.P1-2023-02-08T080125.csv") %>%
  dplyr::slice(1) %>%
  tidyr::pivot_longer(cols = "Alabama":"Puerto Rico", 
                      names_to = "State",
                      values_to = "Pop") %>%
  dplyr::select(State, Pop) %>%
  dplyr::mutate(Pop = as.integer(gsub(",", "", as.character(.$Pop)))) %>%
  dplyr::mutate(Proportion = round(Pop / sum(Pop), 4) * 100,
                Source = "Cenesus_2020") %>%
  dplyr::mutate(PropBins = cut(Proportion,
                              breaks=c(0, 1, 5, 10, 15, 20, 25, 100), 
                              labels=c("< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                       "20~24.9%",">25%")),
                  PropBins = factor(PropBins, 
                                    levels = c("0","< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                               "20~24.9%",">25%")),
                  Colors = cut(Proportion,
                               breaks=c(0, 1, 5, 10, 15, 20, 25, 100), 
                               labels=c("1", "2", "3", "4", "5","6","7")),
                  Colors = factor(Colors, 
                                  levels = c("0","1", "2", "3", "4", "5","6","7"))
                ) %>%
  dplyr::arrange(State)

# df_census_us_geo_p <- us_median_age %>%
#   dplyr::arrange(NAME) %>%
#   dplyr::mutate(Proportion = df_us_census_geo$Proportion,
#                 propBins = df_us_census_geo$propBins)

df_us_ruggeri_geo <- df_us_ruggeri2022 %>%
  dplyr::filter(!is.na(REGION)) %>%
  dplyr::group_by(REGION) %>%
  dplyr::summarise(N = n()) %>%
  dplyr::ungroup() %>%
  dplyr::filter(REGION %in% df_us_census_geo$State) %>%
  dplyr::mutate(Proportion = round(N / sum(N), 4) * 100,
                Source = "Ruggeri_2022") %>%
  dplyr::mutate(PropBins = cut(Proportion,
                              breaks=c(0, 1, 5, 10, 15, 20, 25, 100), 
                              labels=c("< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                       "20~24.9%",">25%")),
                  PropBins = factor(PropBins, 
                                    levels = c("0","< 0.9%", "1~4.9%", "5~9.9%", "10~14.9%", "15~19.9%",
                                               "20~24.9%",">25%")),
                  Colors = cut(Proportion,
                               breaks=c(0, 1, 5, 10, 15, 20, 25, 100), 
                               labels=c("1", "2", "3", "4", "5","6","7")),
                  Colors = factor(Colors, 
                                  levels = c("0","1", "2", "3", "4", "5","6","7"))
                ) %>%
  dplyr::arrange(Proportion) %>%
  dplyr::mutate(REGION = factor(REGION,
                                levels = df_us_census_geo$State)) %>%
  tidyr::complete(REGION, fill = list(PropBins="0", Colors = "0"))
  
df_us_ruggeri_geo_p <- df_us_map %>%
  dplyr::arrange(NAME) %>%
  dplyr::mutate(Proportion = df_us_ruggeri_geo$Proportion,
                propBins = df_us_ruggeri_geo$propBins)

fig3d <- ggplot(data = df_us_map, aes(fill = df_us_census_geo$Colors)) + 
  geom_sf() + 
  scale_fill_manual("Proportions",
                    values = c("#FFFFFF", "#C6DBEF","#9ECAE1","#6BAED6",
                               "#4292C6", "#2171B5", "#08519C","#08306B"),
                    breaks = c("0","1",   "2", "3", 
                               "4", "5", "6","7"),
                    labels = c("0",       "<0.9%",    "1~4.9%", "5~9.9%", 
                               "10~14.9%", "15~19.9%", "20~24.9%",">25%"),
                    drop = FALSE,
      ) + 
  labs(title = "Geographical distribution (Census)",
       #caption = "Data source: 2020 DECENNIALPL, US Census Bureau",
       ) + 
  theme(
        plot.title = element_text(
          color = "black",
          size = 16,
          face = "bold",
          vjust = 0.1,
          hjust = 0.5
        ),
        legend.title = element_blank(),
        # legend.position = "bottom", 
        # legend.justification = "left",
        # legend.direction = "horizontal",
        legend.position =  c(0.9, 0.58), # position of legend
        legend.text=element_text(size=rel(1.5)),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()
      ) +
  ## add north arrow, the style can be changed
      ggspatial::annotation_north_arrow(
        location = 'tl',
        which_north = 'false',
        style = ggspatial::north_arrow_fancy_orienteering()
      ) 

fig3e <- ggplot(data = df_us_map, aes(fill = df_us_ruggeri_geo$Colors)) + 
  geom_sf() + 
    scale_fill_manual("Proportions",
                    values = c("#FFFFFF", "#C6DBEF","#9ECAE1","#6BAED6",
                               "#4292C6", "#2171B5", "#08519C","#08306B"),
                    breaks = c("0","1",   "2", "3", 
                               "4", "5", "6","7"),
                    labels = c("0",       "<0.9%",    "1~4.9%", "5~9.9%", 
                               "10~14.9%", "15~19.9%", "20~24.9%",">25%"),
                    drop = FALSE,
      )  + 
  labs(title = "Geographical distribution (Ruggeri)") + 
  theme(
        plot.title = element_text(
          color = "black",
          size = 16,
          face = "bold",
          vjust = 0.1,
          hjust = 0.5
        ),
        legend.title = element_blank(),
        # legend.position = "bottom", 
        # legend.justification = "left",
        # legend.direction = "horizontal",
        legend.position =  c(0.9, 0.58), # position of legend
        legend.text=element_text(size=rel(1.5)),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()
      ) +
  ## add north arrow, the style can be changed
      ggspatial::annotation_north_arrow(
        location = 'tl',
        which_north = 'false',
        style = ggspatial::north_arrow_fancy_orienteering()
      ) 

fig3 <- (fig3a + fig3b + fig3c + plot_layout(guides = "collect") ) /
  (fig3d + fig3e + plot_layout(guides = "collect")) + 
  plot_annotation(tag_levels = 'A', title = "Data of United States",
                  theme = theme(plot.title = element_text(size = 26))) + 
  plot_layout(heights = c(1, 1.5)) &
  theme(plot.tag = element_text(size = 24),
        text = element_text("Times"))

ggsave("fig1_US.pdf", fig3, device = "pdf", width=18, height = 15)
fig3
```

Save at the final fig 1
```{r}
# fig1_final <- ((fig2a + fig2b + fig2c + plot_layout(guides = "collect") ) /
#                  (fig2d + fig2e + plot_layout(guides = "collect")) +
#                  plot_annotation(tag_levels = 'A', title = "Data of Nigeria",
#                                  theme = theme(plot.title = element_text(size = 26)))) /
#   ((fig1a + fig1b + fig1c + plot_layout(guides = "collect") ) /
#   (fig1e_1 + fig1d_1 + plot_layout(guides = "collect")) + 
#   plot_annotation(tag_levels = 'A', title = "Data of China",
#                                  theme = theme(plot.title = element_text(size = 26)))) /
#   ((fig3a + fig3b + fig3c + plot_layout(guides = "collect") ) /
#   (fig3d + fig3e + plot_layout(guides = "collect")) +
#   plot_annotation(tag_levels = 'A', title = "Data of United States",
#                                  theme = theme(plot.title = element_text(size = 26)))) + 
#   plot_layout(nrow = 6)
#   # plot_annotation(tag_levels = 'A', # title = "Data of United States",
#   #                 theme = theme(plot.title = element_text(size = 26))) + 
#   # plot_layout(heights = c(1, 1.5, 1, 1.5, 1, 1.5)) &
#   theme(plot.tag = element_text(size = 24),
#         text = element_text("Times"))
# ggsave("fig1_final.pdf", fig1_final, device = "pdf", width=18, height = 45)
```